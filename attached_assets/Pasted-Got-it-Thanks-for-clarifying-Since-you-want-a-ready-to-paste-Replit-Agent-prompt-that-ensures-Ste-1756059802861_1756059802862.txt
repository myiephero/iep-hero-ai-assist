Got it âœ… Thanks for clarifying. Since you want a ready-to-paste Replit Agent prompt that ensures Step 3 (Document Upload Fix) aligns with the issue you logged (#45), hereâ€™s the exact block you can drop into the Replit agent chat:

â¸»

ðŸ“Œ Replit Agent Prompt (Step 3 â€“ Document Upload Fix, tied to Issue #45)

Repo: https://github.com/myiephero/iep-hero-ai-assist
Tracking: https://github.com/myiephero/iep-hero-ai-assist/issues/45

â¸»

ðŸš¨ MISSION â€“ Fix Document Upload (POST /api/documents) Authentication + Persistence

Weâ€™re still seeing 401 errors and 500s when uploading to the Document Vault. The browser console shows Supabase session + Bearer tokens, but uploads fail. This is part of the widespread authentication failures logged in Issue #45.

â¸»

ðŸ”¨ Required Fixes
	1.	Server-Side Middleware
	â€¢	Ensure all /api/documents routes (GET, POST, analyze, etc.) use requireAuth with Supabase Bearer validation.
	â€¢	Add [DOCS AUTH DEBUG] logs showing { userId, method, path } when a request is processed.
	2.	POST /api/documents
	â€¢	Ensure middleware order is correct:

app.post("/api/documents", requireAuth, upload.single("document"), async (req, res) => { ... })


	â€¢	Return { success: true, documentId } on success.
	â€¢	Log storage errors clearly with [DOCS UPLOAD ERROR].

	3.	Database Integrity
	â€¢	Ensure documents.owner_id exists and is correctly FKâ€™d â†’ auth.users(id) (see migration file 20250824_fix_documents.sql).
	â€¢	Verify that INSERTs use owner_id from Supabase user.id, not a session/local value.
	4.	Frontend Client
	â€¢	Replace any direct fetch() in Document Vault with the shared apiRequest() helper, which already injects Bearer tokens.
	â€¢	Add [DOCS UPLOAD DEBUG] log in client to show formData keys + API response.
	5.	Service Worker (Cache Busting)
	â€¢	Confirm SW bypasses all POST and /api/ calls:

if (event.request.method !== "GET" || event.request.url.includes("/api/")) {
  return fetch(event.request);
}


	â€¢	Bump SW version to v-docs-auth-002.
	â€¢	Add RED emergency logs:
ðŸš¨ DOCS CACHE BUST [BUILD_ID: ${timestamp}]

â¸»

âœ… Acceptance Criteria
	â€¢	Upload a document via Parent Dashboard â†’ 200/201 response, file appears in Document Vault.
	â€¢	Browser console shows:
	â€¢	[DOCS UPLOAD DEBUG]
	â€¢	ðŸš¨ DOCS CACHE BUST [BUILD_ID=...]
	â€¢	Server logs show [DOCS AUTH DEBUG] userId=... path=/api/documents method=POST.
	â€¢	Supabase documents table row contains:
	â€¢	id
	â€¢	owner_id = correct Supabase UUID
	â€¢	filename, created_at

â¸»

ðŸš« Do Not
	â€¢	Do NOT fallback to demo sessions.
	â€¢	Do NOT bypass requireAuth for testing.
	â€¢	Do NOT close Issue #45 until:
	â€¢	Document upload confirmed working
	â€¢	Screenshots of Supabase row + browser console logs attached

â¸»

ðŸ‘‰ Please implement this one-shot fix for document uploads, commit to repo, and redeploy.

â¸»

Would you like me to also generate the SQL verification query block (ready-to-paste in Supabase SQL editor) so you can quickly confirm that documents.owner_id is set correctly after the agentâ€™s fix?