import { useState, useEffect } from 'react';
import { supabase } from '@/supabaseClient';
import { useAuth } from '@/contexts/AuthContext';

export default function GoalGenerator() {
  const { user } = useAuth();
  const [diagnosis, setDiagnosis] = useState('');
  const [suggestions, setSuggestions] = useState('');
  const [drafts, setDrafts] = useState([]);

  const fetchDrafts = async () => {
    const { data } = await supabase
      .from('iep_drafts')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    setDrafts(data);
  };

  const handleGenerate = async () => {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${import.meta.env.VITE_OPENAI_API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: 'You are an IEP goal writing assistant.' },
          { role: 'user', content: `Suggest IEP goals for a student diagnosed with: ${diagnosis}` }
        ]
      })
    });
    const data = await response.json();
    setSuggestions(data.choices[0].message.content);
  };

  const handleSave = async () => {
    await supabase.from('iep_drafts').insert({
      user_id: user.id,
      diagnosis,
      suggestions
    });
    fetchDrafts();
  };

  useEffect(() => {
    if (user?.id) fetchDrafts();
  }, [user]);

  return (
    <div className="p-6">
      <h1 className="text-xl font-bold mb-4">IEP Goal Generator</h1>
      <input
        type="text"
        placeholder="Enter diagnosis..."
        value={diagnosis}
        onChange={(e) => setDiagnosis(e.target.value)}
        className="w-full mb-2 p-2 border rounded"
      />
      <button onClick={handleGenerate} className="bg-blue-600 text-white px-4 py-2 rounded mb-4">Generate</button>
      {suggestions && (
        <>
          <textarea
            value={suggestions}
            onChange={(e) => setSuggestions(e.target.value)}
            rows="10"
            className="w-full mb-2 p-2 border rounded"
          />
          <button onClick={handleSave} className="bg-green-600 text-white px-4 py-2 rounded mb-6">Save to Supabase</button>
        </>
      )}
      <h2 className="text-lg font-semibold mb-2">Previous Drafts:</h2>
      <ul className="space-y-2">
        {drafts.map((d) => (
          <li key={d.id} className="border p-2 rounded bg-white shadow">{d.suggestions}</li>
        ))}
      </ul>
    </div>
  );
}