# ğŸ› ï¸ Fix GitHub Issue #63: Incorrect Advocate Routing to /my-students before Parent Creation

# ğŸ“‚ FILES TO MODIFY:
# - client/components/Sidebar/Sidebar.tsx
# - client/pages/my-students.tsx
# - client/utils/routeGuards.ts (or create if doesn't exist)
# - client/hooks/useParentClientCheck.ts (new helper)

# âœ… OBJECTIVE:
# Prevent advocates from accessing the /my-students page before creating a parent.
# Fix sidebar and routing logic so the flow is enforced cleanly.

# ğŸ“¦ 1. Create helper hook: useParentClientCheck.ts
mkdir -p client/hooks && cat <<EOF > client/hooks/useParentClientCheck.ts
import { useQuery } from "@tanstack/react-query";
import { apiRequest } from "@/utils/apiRequest";

export function useParentClientCheck() {
  const { data, isLoading, error } = useQuery({
    queryKey: ["advocate-clients"],
    queryFn: () => apiRequest("/api/advocate/clients"),
  });

  return {
    hasClients: Array.isArray(data) && data.length > 0,
    isLoading,
    error,
  };
}
EOF

# ğŸ“¦ 2. Modify Sidebar to disable "My Students" if no clients
sed -i '' 's/const sidebarItems = \[/const { hasClients } = useParentClientCheck();\nconst sidebarItems = \[/' client/components/Sidebar/Sidebar.tsx
sed -i '' 's|label: "My Students"|label: "My Students", disabled: !hasClients|' client/components/Sidebar/Sidebar.tsx

# ğŸ“¦ 3. Guard /my-students route access
cat <<EOF > client/pages/my-students.tsx
import { useEffect } from "react";
import { useRouter } from "next/router";
import { useParentClientCheck } from "@/hooks/useParentClientCheck";
import MyStudentsPage from "@/components/Students/MyStudentsPage";

export default function ProtectedMyStudentsPage() {
  const { hasClients, isLoading } = useParentClientCheck();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !hasClients) {
      alert("Please add a Parent before managing Students.");
      router.replace("/my-parents");
    }
  }, [hasClients, isLoading]);

  if (!hasClients) return null; // Prevent render flash
  return <MyStudentsPage />;
}
EOF

# ğŸ§¼ 4. Clear stale service worker, rebuild app
echo '' > public/sw.js && rm -rf dist && npm run build

# âœ… DONE: Advocate now must create a parent before seeing students
echo "âœ… GitHub Issue #63 resolved. Advocate routing and access logic is now bulletproof."